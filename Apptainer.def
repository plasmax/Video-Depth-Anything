Bootstrap: docker
From: nvidia/cuda:12.1.0-devel-ubuntu22.04

%files
    requirements.txt /

%post
    # Update package lists and install core dependencies
    apt-get update
    apt-get install -y --no-install-recommends \
        git \
        build-essential \
        python3 \
        python3-pip \
        libsm6 \
        libxext6 \
        ffmpeg \
        # Clean up to keep the image small
    && rm -rf /var/lib/apt/lists/*

    # Install specific PyTorch and torchvision versions for CUDA 12.1
    # Note: Use the official PyTorch wheel URL for the correct CUDA version.
    pip3 install torch==2.1.1 torchvision==0.16.1 --extra-index-url https://download.pytorch.org/whl/cu121

    # Install xformers separately first, as recommended for stability
    pip3 install xformers==0.0.23

    # Install remaining dependencies from requirements.txt
    pip3 install -r /requirements.txt

    # Symlink python3 to python for convenience
    ln -s /usr/bin/python3 /usr/bin/python

%environment
    # Set environment variables that your Python script or Apptainer might need
    export PATH=/usr/bin:$PATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%runscript
    # This script runs when you call 'apptainer run'
    echo "This container is built for the Video-Depth-Anything project."
    echo "To run your script, use: apptainer run --nv -B /path/to/your/project:/app video-depth.sif python /app/run.py"

%labels
    Version "1.0"
    Description "Apptainer container for Video-Depth-Anything project"
